'use client';

import { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import Image from 'next/image';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Copy, Plus, Trash2, Pencil, Loader2 } from 'lucide-react';
import { useProfile } from '@/context/ProfileContext';
import { useToast } from '@/hooks/use-toast';
import Link from 'next/link';
import { useUser, useFirestore, useFirebaseApp } from '@/firebase';
import { doc, updateDoc } from 'firebase/firestore';
import { uploadFile } from '@/firebase/storage';

export default function CustomizationPage() {
    const { toast } = useToast();
    const { profile, updateAvatar, updateBanner, updateProfile } = useProfile();
    const { user } = useUser();
    const firestore = useFirestore();
    const firebaseApp = useFirebaseApp();
    
    const [name, setName] = useState(profile.name);
    const [handle, setHandle] = useState(profile.handle.replace('@', ''));
    const [description, setDescription] = useState(profile.description);
    const [contactEmail, setContactEmail] = useState(profile.email || '');
    const [links, setLinks] = useState(profile.links);
    const [dob, setDob] = useState(profile.dob);
    const [gender, setGender] = useState(profile.gender);
    const [isPublishing, setIsPublishing] = useState(false);

    const avatarInputRef = useRef<HTMLInputElement>(null);
    const bannerInputRef = useRef<HTMLInputElement>(null);

    // Sync local state with profile context when it loads
    useEffect(() => {
        if (profile.id) {
            setName(profile.name);
            setHandle(profile.handle.replace('@', ''));
            setDescription(profile.description);
            setContactEmail(profile.email || '');
            setLinks(profile.links || []);
            setDob(profile.dob);
            setGender(profile.gender);
        }
    }, [profile]);


    const addLink = () => {
        if (links.length < 5) {
            setLinks([...links, { title: '', url: '' }]);
        }
    };

    const removeLink = (index: number) => {
        setLinks(links.filter((_, i) => i !== index));
    };

    const handleLinkChange = (index: number, field: 'title' | 'url', value: string) => {
        const newLinks = [...links];
        newLinks[index][field] = value;
        setLinks(newLinks);
    };

    const handleImageChange = async (
        e: React.ChangeEvent<HTMLInputElement>,
        imageType: 'avatar' | 'banner'
    ) => {
        if (!user || !firebaseApp) {
            toast({ title: 'You must be logged in to upload images.', variant: 'destructive'});
            return;
        }

        const file = e.target.files?.[0];
        if (file) {
            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                toast({ title: 'Image too large', description: 'Please select an image smaller than 2MB.', variant: 'destructive'});
                return;
            }
            
            const toastId = toast({ title: `Uploading ${imageType}...`}).id;
            
            try {
                const filePath = `${imageType}s/${user.uid}-${file.name}`;
                const downloadURL = await uploadFile(firebaseApp, file, filePath);

                const userRef = doc(firestore, 'users', user.uid);
                const fieldToUpdate = imageType === 'avatar' ? 'avatarUrl' : 'bannerUrl';
                await updateDoc(userRef, { [fieldToUpdate]: downloadURL });
                
                if (imageType === 'avatar') {
                    updateAvatar(downloadURL);
                } else {
                    updateBanner(downloadURL);
                }

                toast({ id: toastId, title: `${imageType.charAt(0).toUpperCase() + imageType.slice(1)} updated!` });
            } catch (error) {
                toast({ id: toastId, title: `Failed to upload ${imageType}`, description: (error as Error).message, variant: 'destructive' });
            }
        }
    };


    const handlePublish = async () => {
        if (!user || !firestore) {
            toast({ title: "You must be logged in to make changes.", variant: "destructive" });
            return;
        }

        setIsPublishing(true);

        const profileDataToSave = {
            displayName: name,
            username: handle.startsWith('@') ? handle.substring(1) : handle,
            description,
            email: contactEmail,
            links,
            dob,
            gender,
        };

        try {
            const userRef = doc(firestore, 'users', user.uid);
            await updateDoc(userRef, profileDataToSave);
            
            // Update local context after successful save
            updateProfile({
                name,
                handle: `@${profileDataToSave.username}`,
                description,
                email: contactEmail,
                links,
                dob,
                gender,
            });

            toast({
                title: "Channel updated successfully!",
            });
        } catch (error) {
            console.error("Error updating profile:", error);
            toast({
                title: "Failed to update channel",
                description: (error as Error).message,
                variant: "destructive"
            });
        } finally {
            setIsPublishing(false);
        }
    };

    const channelHandle = profile.handle.startsWith('@') ? profile.handle.substring(1) : profile.handle;

    return (
        <div className="p-4 md:p-6 lg:p-8 space-y-6">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h1 className="text-2xl font-bold">Channel customization</h1>
                <div className="flex items-center gap-2">
                    <Link href={`/channel/${channelHandle}`}>
                        <Button variant="ghost" disabled={isPublishing}>View channel</Button>
                    </Link>
                    <Button variant="outline" disabled={isPublishing}>Cancel</Button>
                    <Button onClick={handlePublish} disabled={isPublishing}>
                        {isPublishing && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                        {isPublishing ? 'Publishing...' : 'Publish'}
                    </Button>
                </div>
            </div>

            <Tabs defaultValue="branding" className="w-full">
                <TabsList className="bg-transparent p-0 border-b rounded-none h-auto justify-start">
                    <TabsTrigger value="layout">Layout</TabsTrigger>
                    <TabsTrigger value="branding">Branding</TabsTrigger>
                    <TabsTrigger value="basic-info">Basic info</TabsTrigger>
                </TabsList>
                <TabsContent value="layout" className="mt-6">
                    <Card>
                        <CardHeader>
                            <CardTitle>Layout</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <p className="text-muted-foreground">Customize the layout of your channel homepage. Add a video spotlight and featured sections.</p>
                        </CardContent>
                    </Card>
                </TabsContent>
                <TabsContent value="branding" className="mt-6 space-y-8">
                     <Card>
                        <CardHeader>
                            <CardTitle>Picture</CardTitle>
                        </CardHeader>
                        <CardContent className="flex flex-col md:flex-row items-center gap-6">
                            <Link href={`/channel/${channelHandle}`} className="block">
                                <Image src={profile.avatarUrl} width={128} height={128} alt="Profile Picture" className="rounded-full object-cover" data-ai-hint={profile.dataAiHint} />
                            </Link>
                            <div className="flex-1">
                                <p className="text-sm text-muted-foreground mb-3">
                                    Your profile picture will appear where your channel is presented on MyTube, like next to your videos and comments. It’s recommended to use a picture that’s at least 128 x 128 pixels and 2MB or less. Use a PNG or GIF (no animations) file.
                                </p>
                                <div className="flex items-center gap-2">
                                    <input type="file" ref={avatarInputRef} onChange={(e) => handleImageChange(e, 'avatar')} className="hidden" accept="image/*" />
                                    <Button variant="outline" onClick={() => avatarInputRef.current?.click()}>Change</Button>
                                    <Button variant="ghost" onClick={() => updateAvatar('https://placehold.co/128x128.png')}>Remove</Button>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                     <Card>
                        <CardHeader>
                            <CardTitle>Banner image</CardTitle>
                        </CardHeader>
                        <CardContent className="flex flex-col-reverse md:flex-row items-center gap-6">
                             <div className="flex-1">
                                <p className="text-sm text-muted-foreground mb-3">
                                    This image will appear across the top of your channel. For the best results on all devices, use an image that’s at least 1080 x 240 pixels and 2MB or less.
                                </p>
                                <div className="flex items-center gap-2">
                                     <input type="file" ref={bannerInputRef} onChange={(e) => handleImageChange(e, 'banner')} className="hidden" accept="image/*" />
                                    <Button variant="outline" onClick={() => bannerInputRef.current?.click()}>Change</Button>
                                    <Button variant="ghost" onClick={() => updateBanner('https://placehold.co/1080x240.png')}>Remove</Button>
                                </div>
                            </div>
                            <Image src={profile.bannerUrl} width={1080} height={240} alt="Banner Preview" className="rounded-md object-contain border p-2 bg-secondary/30 max-w-sm w-full" data-ai-hint={profile.bannerHint} />
                        </CardContent>
                    </Card>

                      <Card>
                        <CardHeader>
                            <CardTitle>Video watermark</CardTitle>
                        </CardHeader>
                        <CardContent className="flex flex-col md:flex-row items-center gap-6">
                             <div className="flex-1">
                                <p className="text-sm text-muted-foreground mb-3">
                                    The watermark will appear on your videos in the right-hand corner of the video player.
                                </p>
                                <RadioGroup defaultValue="entire" className="space-y-2 mb-4">
                                    <div className="flex items-center space-x-2">
                                        <RadioGroupItem value="end" id="end"/>
                                        <Label htmlFor="end" className="font-normal">End of video</Label>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <RadioGroupItem value="custom" id="custom" />
                                        <Label htmlFor="custom" className="font-normal">Custom start time</Label>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <RadioGroupItem value="entire" id="entire"/>
                                        <Label htmlFor="entire" className="font-normal">Entire video</Label>
                                    </div>
                                </RadioGroup>
                                <div className="flex items-center gap-2">
                                    <Button variant="outline">Change</Button>
                                    <Button variant="ghost">Remove</Button>
                                </div>
                            </div>
                            <div className="relative w-full max-w-sm h-auto aspect-video rounded-md overflow-hidden border bg-secondary/30 flex items-center justify-center">
                                <Image src="https://placehold.co/400x225.png" width={400} height={225} alt="Video watermark preview" className="opacity-50" data-ai-hint="video player"/>
                                <Image src="https://placehold.co/48x48.png" width={48} height={48} alt="Watermark" className="absolute bottom-2 right-2 border-2 border-white/50" data-ai-hint="subscribe icon"/>
                            </div>
                        </CardContent>
                    </Card>
                 </TabsContent>
                <TabsContent value="basic-info" className="mt-6 space-y-8">
                    <Card>
                        <CardHeader>
                            <CardTitle>Name & Handle</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="space-y-2">
                                <Label htmlFor="name">Name</Label>
                                <div className="relative">
                                    <Input id="name" value={name} onChange={(e) => setName(e.target.value)} />
                                    <Pencil className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                                </div>
                            </div>
                            <div className="space-y-2">
                                <Label htmlFor="handle">Handle</Label>
                                <Input id="handle" value={handle} onChange={(e) => setHandle(e.target.value)} />
                                <p className="text-xs text-muted-foreground">Choose your unique handle by adding letters and numbers. You can change your handle back within 14 days.</p>
                            </div>
                        </CardContent>
                    </Card>

                     <Card>
                        <CardHeader><CardTitle>Description</CardTitle></CardHeader>
                        <CardContent>
                            <Textarea rows={10} value={description} onChange={(e) => setDescription(e.target.value)} />
                        </CardContent>
                    </Card>

                      <Card>
                        <CardHeader><CardTitle>Channel URL</CardTitle></CardHeader>
                        <CardContent>
                            <p className="text-sm text-muted-foreground mb-2">This is the standard web address for your channel. It includes your unique channel ID, which is the numbers and letters at the end of the URL.</p>
                            <div className="flex items-center gap-2">
                                <Input readOnly value={`https://mytube.com/channel/${profile.id}`} />
                                <Button variant="ghost" size="icon" onClick={() => navigator.clipboard.writeText(`https://mytube.com/channel/${profile.id}`)}><Copy className="h-4 w-4" /></Button>
                            </div>
                        </CardContent>
                    </Card>
                    
                    <Card>
                        <CardHeader>
                            <CardTitle>Date of Birth</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <Input type="date" value={dob} onChange={(e) => setDob(e.target.value)} />
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Gender</CardTitle>
                        </CardHeader>
                        <CardContent>
                             <RadioGroup value={gender} onValueChange={setGender} className="flex gap-4">
                                <div className="flex items-center space-x-2">
                                    <RadioGroupItem value="male" id="male" />
                                    <Label htmlFor="male">Male</Label>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <RadioGroupItem value="female" id="female" />
                                    <Label htmlFor="female">Female</Label>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <RadioGroupItem value="other" id="other" />
                                    <Label htmlFor="other">Other</Label>
                                </div>
                             </RadioGroup>
                        </CardContent>
                    </Card>

                     <Card>
                        <CardHeader>
                            <CardTitle>Links</CardTitle>
                            <CardDescription>Share external links with your viewers. They'll be visible on your channel profile and about page.</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            {links.map((link, index) => (
                                <div key={index} className="flex items-end gap-2">
                                    <div className="flex-1 grid grid-cols-2 gap-2">
                                        <Input placeholder="Link title (required)" value={link.title} onChange={(e) => handleLinkChange(index, 'title', e.target.value)} />
                                        <Input placeholder="URL (required)" value={link.url} onChange={(e) => handleLinkChange(index, 'url', e.target.value)} />
                                    </div>
                                    <Button variant="ghost" size="icon" onClick={() => removeLink(index)}>
                                        <Trash2 className="h-4 w-4 text-destructive" />
                                    </Button>
                                </div>
                            ))}
                            <Button variant="outline" onClick={addLink} disabled={links.length >= 5}>
                                <Plus className="mr-2 h-4 w-4" /> Add Link
                            </Button>
                        </CardContent>
                    </Card>

                     <Card>
                        <CardHeader>
                            <CardTitle>Contact info</CardTitle>
                            <CardDescription>Let people know how to contact you with business inquiries. The email address you enter may appear in the About section of your channel and be visible to viewers.</CardDescription>
                        </CardHeader>
                         <CardContent>
                            <Label htmlFor="contact-email">Email</Label>
                            <Input id="contact-email" type="email" placeholder="Enter your email address" value={contactEmail} onChange={(e) => setContactEmail(e.target.value)} />
                        </CardContent>
                    </Card>
                 </TabsContent>
            </Tabs>
        </div>
    );
}
